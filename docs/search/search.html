<html><head><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><title>Elastic4s</title><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="description" content="Elasticsearch Scala Client" /><meta name="author" content="Stephen Samuel" /><meta name="og:image" content="/elastic4s/img/poster.png" /><meta name="og:title" content="Elastic4s" /><meta name="og:site_name" content="Elastic4s" /><meta name="og:url" content="https://sksamuel.github.io/elastic4s" /><meta name="og:type" content="website" /><meta name="og:description" content="Elasticsearch Scala Client" /><meta name="twitter:image" content="/elastic4s/img/poster.png" /><meta name="twitter:card" content="summary_large_image" /><meta name="twitter:site" content="" /><link rel="icon" type="image/png" href="/elastic4s/img/favicon.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/elastic4s/highlight/styles/atom-one-light.css" /><link rel="stylesheet" href="/elastic4s/css/style.css" /><link rel="stylesheet" href="/elastic4s/css/palette.css" /><link rel="stylesheet" href="/elastic4s/css/override.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/elastic4s/" class="brand"><div class="brand-wrapper" style="background:url('/elastic4s/img/sidebar_brand.png') no-repeat"><span>Elastic4s</span></div></a></li> <li><a href="/elastic4s/docs/index.html" class="">Getting Started</a></li> <li><a href="/elastic4s/docs/document/index.html" class="">Document API</a> <ul class="sub_section"> <li><a href="/elastic4s/docs/document/index.html" class="">Index</a></li> <li><a href="/elastic4s/docs/document/get.html" class="">Get</a></li> <li><a href="/elastic4s/docs/document/multiget.html" class="">Multi Get</a></li> <li><a href="/elastic4s/docs/document/delete.html" class="">Delete</a></li> <li><a href="/elastic4s/docs/document/update.html" class="">Update</a></li> <li><a href="/elastic4s/docs/document/bulk.html" class="">Bulk</a></li></ul></li> <li><a href="/elastic4s/docs/search/search.html" class=" active ">Search API</a> <ul class="sub_section"> <li><a href="/elastic4s/docs/search/multisearch.html" class="">Multi Search</a></li> <li><a href="/elastic4s/docs/search/explain.html" class="">Explain</a></li> <li><a href="/elastic4s/docs/search/suggestions.html" class="">Suggestions</a></li> <li><a href="/elastic4s/docs/search/validate.html" class="">Validate</a></li> <li><a href="/elastic4s/docs/search/count.html" class="">Count</a></li></ul></li> <li><a href="/elastic4s/docs/indices/createindex.html" class="">Indices API</a> <ul class="sub_section"> <li><a href="/elastic4s/docs/indices/createindex.html" class="">Create Index</a></li> <li><a href="/elastic4s/docs/indices/aliases.html" class="">Aliases</a></li> <li><a href="/elastic4s/docs/indices/optimize.html" class="">Optimize</a></li></ul></li> <li><a href="/elastic4s/docs/misc/analyzers.html" class="">Analyzers</a></li> <li><a href="/elastic4s/docs/misc/snapshot.html" class="">Snapshot</a></li> <li><a href="/elastic4s/docs/misc/javainterop.html" class="">Java Interop</a></li> <li><a href="/elastic4s/api/index.html" class="">Scaladoc</a></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li class="hidden-xs"><a href="https://github.com/sksamuel/elastic4s"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li class="hidden-xs"><a href="https://github.com/sksamuel/elastic4s"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('Elastic4s Elasticsearch Scala Client');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('Elastic4s Elasticsearch Scala Client');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="sksamuel" data-github-repo="elastic4s"><div class="content-wrapper"><section><h1 id="searching">Searching</h1>

<p>Searching is naturally the most involved operation. There are many ways to do <a href="http://www.elasticsearch.org/guide/reference/api/search/">searching in elastic search</a> and that is reflected
in the higher complexity of the search DSL.</p>

<p>To do a simple string query search, where the search query is parsed from a single string
<code class="highlighter-rouge">scala
search in "places"-&gt;"cities" query "London"
</code></p>

<p>We can search for everything by not specifying a query at all.
<code class="highlighter-rouge">scala
search in "places"-&gt;"cities"
</code></p>

<p>We might want to limit the number of results and / or set the offset.
<code class="highlighter-rouge">scala
search in "places"-&gt;"cities" query "paris" start 5 limit 10
</code></p>

<p>One of the great features of Elasticsearch is the number of queries it provides. Here we can use the term query to limit the search to just the state of Georgia rather than the country of Georgia.
<code class="highlighter-rouge">scala
search in "places"-&gt;"cities" query { termQuery("state", "georgia") }
</code></p>

<p>We wouldn’t be able to do very much if we couldn’t combine queries. So here we combine three queries, 2 “musts” that must match the documents and 1 “not” that must not match the documents. This is what ElasticSearch calls a <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-bool-query.html">boolean query</a>. You’ll see in this example that I don’t like to vacation anywhere that is too hot, and I want to only vacation somewhere that is awesome and that where the name ends with ‘cester’ like Gloucester or Leicester.
<code class="highlighter-rouge">scala
search in "places"-&gt;"cities" query {
   bool {
       must(
           regexQuery("name", ".*cester"),
           termQuery("status", "Awesome")
       ) not (
            termQuery("weather", "hot")
       )
   }
}
</code></p>

<p>It is also possible to use raw json queries. This provides more flexibility (i.e when the DSL is not complete) and enables storing queries in a separate environment (DB, cache, etc.).
<code class="highlighter-rouge">scala
search in "*" types("users", "tweets") limit 5 rawQuery {
  """{ "prefix": { "bands": { "prefix": "coldplay", "boost": 5.0, "rewrite": "yes" } } }"""
} searchType SearchType.Scan
</code></p>

<p>Or initialize the entire SearchRequestBuilder from a json string. This provides more flexibility (i.e when the DSL is not complete) and enables storing queries in a separate environment (DB, cache, etc.).
<code class="highlighter-rouge">scala
search in "*" types("users", "tweets") limit 5 extraSource {
  """{ "query": { "prefix": { "bands": { "prefix": "coldplay", "boost": 5.0, "rewrite": "yes" } } } }"""
} searchType SearchType.Scan
</code></p>

<p>Elasticsearch provides <a href="http://www.elasticsearch.org/guide/reference/api/search/facets/">sorting</a> of course. So does elastic4s. You can even include multiple sorts - rather like multiple order clauses in an SQL query.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">search</span> <span class="n">in</span> <span class="s">"places"</span><span class="o">-&gt;</span><span class="s">"cities"</span> <span class="n">query</span> <span class="s">"europe"</span> <span class="n">sort</span> <span class="o">(</span>
    <span class="n">field</span> <span class="n">sort</span> <span class="s">"name"</span><span class="o">,</span>
    <span class="n">field</span> <span class="n">sort</span> <span class="s">"status"</span>
<span class="o">)</span>
</code></pre>
</div>

<h2 id="aggregations">Aggregations</h2>

<p><a href="http://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html">Aggregations</a> are the new <a href="http://www.elastic.co/guide/en/elasticsearch/reference/current/search-facets.html">facets</a>. The basic way of doing aggregations in elastic4s is this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">client</span><span class="o">.</span><span class="n">execute</span> <span class="o">{</span>
  <span class="n">search</span> <span class="n">in</span> <span class="s">"index"</span> <span class="o">/</span> <span class="s">"type"</span> <span class="n">query</span> <span class="o">&lt;</span><span class="n">somequery</span><span class="o">&gt;</span> <span class="n">aggregations</span><span class="o">(</span>
    <span class="n">aggregation</span> <span class="n">terms</span> <span class="s">"agg1"</span> <span class="n">field</span> <span class="s">"field1"</span> <span class="n">size</span> <span class="mi">20</span><span class="o">,</span>
    <span class="n">aggregation</span> <span class="n">avg</span> <span class="s">"agg2"</span> <span class="n">field</span> <span class="s">"field2"</span>
  <span class="o">)</span>
<span class="o">}</span>
</code></pre>
</div>

<p>That would create two aggregations, one for the number of terms up to the 20 most common values in “field1”, and one for the avg of the values in “field2”</p>

<h4 id="source-filtering">Source Filtering</h4>

<p>We can control which parts of the source are returned to us using source filtering. Let’s carry on our places/cities
example, but now lets suppose the document has many more fields, such as population, foundation date,
gps coordinates. We can specify which ones are included / excludes by using the <code class="highlighter-rouge">sourceInclude</code> and <code class="highlighter-rouge">sourceExclude</code>
methods. This is useful functionality to trim down large documents from being sent over the wire.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">client</span><span class="o">.</span><span class="n">execute</span> <span class="o">{</span>
  <span class="n">search</span> <span class="n">in</span> <span class="s">"places/cities"</span> <span class="n">query</span> <span class="s">"europe"</span> <span class="n">sourceInclude</span><span class="o">(</span><span class="s">"gps"</span><span class="o">,</span> <span class="s">"populat*"</span><span class="o">)</span> <span class="n">sourceExclude</span><span class="o">(</span><span class="s">"denonymn"</span><span class="o">,</span> <span class="s">"capit*"</span><span class="o">)</span>
<span class="o">}</span>
</code></pre>
</div>

<p>We can specify multiple includes/excludes and they recognize regular expressions. Read more in the <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/search-request-source-filtering.html">elasticsearch
docs</a></p>

<p>Other options provided are highlighting, suggestions, filters, scrolling, index boosts and scripting. See <a href="http://www.elasticsearch.org/guide/reference/api/search/">the query dsl</a> for more information.</p>

<h2 id="inner-hits">Inner Hits</h2>

<p>Since version 1.5.0, Elasticsearch has supported <a href="http://www.elastic.co/guide/en/elasticsearch/reference/1.5/search-request-inner-hits.html">inner hits</a>.</p>

<p>To do top level inner hits in elastic4s we can do:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">search</span> <span class="n">in</span> <span class="s">"index"</span> <span class="o">/</span> <span class="s">"type"</span> <span class="n">inner</span> <span class="o">(</span>
  <span class="n">inner</span> <span class="n">hit</span> <span class="s">"name"</span> <span class="n">path</span> <span class="s">"path"</span><span class="o">,</span>
  <span class="n">inner</span> <span class="n">hit</span> <span class="s">"name"</span> <span class="n">`type`</span> <span class="s">"type"</span>
<span class="o">)</span>
</code></pre>
</div>

<p>And to use inner hits on nested queries we can do:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">search</span> <span class="n">in</span> <span class="s">"index"</span> <span class="o">/</span> <span class="s">"type"</span> <span class="n">query</span> <span class="o">{</span>
  <span class="n">nestedQuery</span><span class="o">(</span><span class="s">"somepath"</span><span class="o">)</span> <span class="n">inner</span> <span class="o">{</span>
    <span class="n">inner</span> <span class="n">hits</span> <span class="s">"name"</span> <span class="n">from</span> <span class="mi">2</span> <span class="n">size</span> <span class="mi">10</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h2 id="script-fields">Script Fields</h2>

<p>We can use script fields to evaluate a field for each hit. Script fields can even operate on fields that are not stored. Script fields can include parameters which can be accessed when the script is evaluted.</p>

<p>We can specify the script fields in a search query through the use of the <code class="highlighter-rouge">scriptfields</code> method:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">search</span> <span class="n">in</span> <span class="s">"tubestops"</span> <span class="n">query</span> <span class="s">"wimbledon"</span> <span class="n">scriptfields</span> <span class="o">(</span>
  <span class="n">script</span> <span class="n">field</span> <span class="s">"fare_cost"</span> <span class="n">script</span> <span class="s">"doc['zone'] * fare_per_zone"</span> <span class="n">params</span> <span class="nc">Map</span><span class="o">(</span><span class="s">"fare_per_zone"</span> <span class="o">-&gt;</span> <span class="mf">3.00</span><span class="o">)</span>
<span class="o">)</span>
</code></pre>
</div>

<p>The general form of scriptfield DSL expressions is:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>script field &lt;field_name&gt; script &lt;script&gt; (lang &lt;lang_name&gt;){0,1} (params &lt;Map[String,Any]&gt;){0,1}
</code></pre>
</div>

<p>See the <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/search-request-script-fields.html">script fields</a> section of the elasticsearch guide for greater detail of the use of script fields in searches.</p>
</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/elastic4s/highlight/highlight.pack.js"></script><script>hljs.configure({
languages:['scala','java','bash']
});
hljs.initHighlighting();
             </script><script src="/elastic4s/js/main.js"></script></body></html>